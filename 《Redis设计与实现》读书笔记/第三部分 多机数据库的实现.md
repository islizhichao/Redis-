# 第15章 复制

## 15.1 旧版复制功能的实现

Redis的复制功能分为同步和命令传播两个操作：

- 同步操作是将从服务器的数据库状态更新至主服务器当前所处的数据库状态
- 命令传播则用于将主服务器的数据库状态被修改，导致主从服务器的数据库状态出现不一致时，让主从服务器的数据库重新回到一致状态。



![1595943647612](C:\Users\李志超\AppData\Roaming\Typora\typora-user-images\1595943647612.png)

## 15.4 部分重同步的实现

三部分组成：

- 主服务器的复制偏移量和从服务器的复制偏移量
- 主服务器的复制积压缓冲区
- 服务器的运行ID

### 15.4.1 复制偏移量

执行复制的双方——主、从服务器分别维护一个复制偏移量：

- 主服务器每次向从服务器传播N个字节的数据时，就将自己的复制偏移量的值加上N
- 从服务器每次收到主服务器的N个字节数据的时候，就在自己的数据偏移量上加上N

### 15.4.2 复制积压缓冲区

### 15.4.3 服务器运行ID

- 每个Redis服务器，不论主服务器还是从服务器，都会有自己的运行ID
- 运行ID在服务器启动时自动生成

当从服务器重新连上一个主服务器时，

- 如果从服务器保存的运行ID与当前连接的主服务器的运行ID相同，那么可以尝试执行部分重同步操作
- 如果不同，则执行完整重同步操作
